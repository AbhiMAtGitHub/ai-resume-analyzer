name: Build, Push & Update Lambda Image

on:
  workflow_dispatch:
    inputs:
      lambda_name:
        description: "Select the Lambda function to deploy"
        required: true
        type: choice
        options:
          - file-handler
          - start-pdf-text-extraction
        default: file-handler

  push:
    branches:
      - "main"
      - "feature/**"
    paths:
      - "docker/**"
      - "resume_analyzer/**"
      - "pyproject.toml"

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy-lambda:
    name: Build, Push Image & Update Lambda
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1
      PROJECT_SLUG: resume-analyzer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install uv (for pyproject.toml)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # ðŸ§  NEW STEP: Set Lambda metadata dynamically based on dropdown selection
      - name: Set build context for selected Lambda
        id: set-lambda
        run: |
          echo "Selected Lambda: ${{ github.event.inputs.lambda_name }}"

          if [ "${{ github.event.inputs.lambda_name }}" = "file-handler" ]; then
            echo "IMAGE_NAME=file-handler" >> $GITHUB_ENV
            echo "DOCKERFILE_PATH=docker/Dockerfile.file_handler" >> $GITHUB_ENV
            echo "LAMBDA_FUNCTION_NAME=resume-analyzer-file-handler" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.lambda_name }}" = "start-pdf-text-extraction" ]; then
            echo "IMAGE_NAME=start-pdf-text-extraction" >> $GITHUB_ENV
            echo "DOCKERFILE_PATH=docker/Dockerfile.start_pdf_text_extraction" >> $GITHUB_ENV
            echo "LAMBDA_FUNCTION_NAME=resume-analyzer-start-pdf-text-extraction" >> $GITHUB_ENV
          else
            echo "Invalid lambda_name input"
            exit 1
          fi

          echo "Context set for ${{ github.event.inputs.lambda_name }}"

      # ðŸ§© NEW STEP: Ensure ECR repository exists (idempotent)
      - name: Ensure ECR repository exists
        run: |
          REPO_NAME="${{ env.PROJECT_SLUG }}/${{ env.IMAGE_NAME }}"
          echo "Checking if ECR repo $REPO_NAME exists..."
          if ! aws ecr describe-repositories --repository-names "$REPO_NAME" --region $AWS_REGION >/dev/null 2>&1; then
            echo "Creating ECR repository $REPO_NAME..."
            aws ecr create-repository \
              --repository-name "$REPO_NAME" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=KMS \
              --region $AWS_REGION >/dev/null
            echo "ECR repository created: $REPO_NAME"
          else
            echo "ECR repository already exists."
          fi

      - name: Build Docker image for Lambda
        run: |
          IMAGE_TAG=build-${{ github.sha }}
          IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.PROJECT_SLUG }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

          echo "ðŸ”¨ Building Docker image from $DOCKERFILE_PATH ..."
          docker build -t $IMAGE_URI -f $DOCKERFILE_PATH .

      - name: Push image to Amazon ECR
        run: |
          echo "Pushing $IMAGE_URI"
          docker push $IMAGE_URI

      - name: Update Lambda function image
        run: |
          echo "Updating Lambda ${LAMBDA_FUNCTION_NAME} to new image..."
          aws lambda update-function-code \
            --function-name $LAMBDA_FUNCTION_NAME \
            --image-uri $IMAGE_URI \
            --region $AWS_REGION

      - name: Wait for Lambda update completion
        run: |
          echo "Waiting for Lambda to finish deploying..."
          aws lambda wait function-updated \
            --function-name $LAMBDA_FUNCTION_NAME \
            --region $AWS_REGION
          echo "Lambda now running image: $IMAGE_TAG"

      - name: Summary
        run: |
          echo "----------------------------------------"
          echo "Lambda successfully updated!"
          echo "Function: $LAMBDA_FUNCTION_NAME"
          echo "Image: $IMAGE_URI"
          echo "Region: $AWS_REGION"
          echo "----------------------------------------"
